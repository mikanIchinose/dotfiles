#!/usr/bin/env bash
# レビューしたPRをApproveする

set -e

function exist-command?() {
  if ! command -v "$1" &>/dev/null; then
    printf "$1 is not exist"
    exit 1
  fi
}

# check dependencies {{{
exist-command? gum
exist-command? shuf
exist-command? gh
# }}}


# main logic {{{
pullRequests=$(gh pr list \
  --search "review-requested:@me -is:draft" \
  --json number \
  --json title \
  --jq '.[] | [.number,.title] | join(" ")' \
)
selectedPullRequest=$(echo "$pullRequests" | gum choose | awk '{print $1}')

test "$selectedPullRequest" = "" && exit 0

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
gum confirm "continue?" \
  && gh pr review $selectedPullRequest --approve --body $(deno run -A "$SCRIPT_DIR/fetchLGTMImage.ts")
# }}}
