---
name: self-improve
description: 作業を振り返ってCLAUDE.mdやスキルを改善する自己改善ループ
---

セッション中の作業を振り返り、CLAUDE.md やスキルの改善に繋げる。
以下の5フェーズを順に実行する。

---

## Phase 1: データ収集

1. セッションコンテキスト (`/tmp/claude-contexts/{project}_{branch}.md`) があれば読み込む
2. `~/.claude/lessons-learned.md` があれば読み込む
3. 会話全体を振り返り対象とする

## Phase 2: KPT振り返り

会話を分析し、KPTフォーマットで振り返りを出力する。

```markdown
## Keep
- うまく行ったこと、続けるべきこと

## Problem
- 失敗したこと、ユーザーから修正を受けたこと、非効率だったこと

## Try
- Problem に対する改善案
```

## Phase 3: シグナル検出・分類

Phase 2 の Problem/Try + 会話全体から **改善シグナル** を検出する。
`references/analysis-guide.md` のパターン定義を参照すること。

### 検出対象シグナル
- ユーザー修正（「違う」「そうじゃなくて」、やり直し指示）
- ツール失敗・リトライ
- 非効率パターン（不要なファイル読み込み、冗長手順）
- 繰り返し手動操作

### 分類テーブル

各シグナルを以下のターゲットに分類する:

| ターゲット | 条件 |
|-----------|------|
| グローバル CLAUDE.md (`~/.claude/CLAUDE.md`) | プロジェクト横断の行動ルール |
| プロジェクト CLAUDE.md (`./CLAUDE.md`) | プロジェクト固有のルール |
| 既存スキル改善 | ワークフロー不備 |
| 新規スキル提案 | 3回以上繰り返される手動パターン |
| lessons-learned 記録のみ | 一度きりの知見 |

分類結果をテーブル形式で出力する:

```markdown
## 検出シグナル

| # | シグナル | ターゲット | 推奨/任意 | 提案内容 |
|---|---------|-----------|----------|---------|
| 1 | ... | グローバル CLAUDE.md | 推奨 | ... |
| 2 | ... | lessons-learned | 任意 | ... |
```

## Phase 4: 改善提案・適用

1. Phase 3 の分類結果を **「推奨」と「任意」に分けて** 提示する
2. ユーザーに **どの改善を適用するか確認を取る**（複数の改善を適用する前に必ず確認）
3. 承認された改善を CLAUDE.md / スキルファイルに反映する
4. 変更後 `git diff` で確認を出力する

### 編集時の注意
- CLAUDE.md は既存の構造・セクションを尊重し、適切な位置に追記する
- 重複するルールがあれば統合する
- スキル改善の場合は該当スキルの SKILL.md を編集する

## Phase 5: lessons-learned 更新

全シグナルと対応結果を `~/.claude/lessons-learned.md` に追記する。

フォーマット:

```markdown
## YYYY-MM-DD — {プロジェクト名}

| シグナル | 分類 | 対応 | ステータス |
|---------|------|------|-----------|
| ... | グローバル CLAUDE.md | ルール追加 | 適用済み |
| ... | lessons-learned | 記録のみ | 記録済み |
```
