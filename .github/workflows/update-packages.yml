name: update-packages
on:
  schedule:
    - cron: '0 1 * * *'
jobs:
  update-packages:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.WORKFLOW_PAT }}
      - name: Setup nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Setup git
        run: |
          git config --local user.name "GitHub Action"
          git config --local user.email "actions@github.com"
      - name: Update packages
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        run: |
          for script in nix/packages/*/update.sh; do
            pkg="$(basename "$(dirname "$script")")"
            echo "::group::Updating $pkg"
            bash "$script" || true
            echo "::endgroup::"
          done
      - name: Format
        run: nix fmt
      - name: Build check
        id: build-check
        run: |
          failed=()
          for dir in nix/packages/*/; do
            pkg="$(basename "$dir")"
            echo "::group::Building $pkg"
            if ! nix build ".#$pkg"; then
              echo "::warning::$pkg failed to build, reverting"
              git checkout -- "$dir"
              failed+=("$pkg")
            fi
            echo "::endgroup::"
          done
          if [ ${#failed[@]} -gt 0 ]; then
            echo "reverted=${failed[*]}" >> "$GITHUB_OUTPUT"
          fi
      - name: Commit and push
        id: commit
        run: |
          branch="nix/update-packages"
          git checkout -B "$branch"
          git add .
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "nix: update packages"
          git push -f origin "$branch"
          echo "changed=true" >> "$GITHUB_OUTPUT"
      - name: Create or update PR
        if: steps.commit.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        run: |
          branch="nix/update-packages"
          body="Automated package update."
          reverted="${{ steps.build-check.outputs.reverted }}"
          if [ -n "$reverted" ]; then
            body=$(cat <<'HEREDOC'
          Automated package update.

          > [!WARNING]
          > Build failed and reverted: REVERTED_PLACEHOLDER
          HEREDOC
            )
            body="${body//REVERTED_PLACEHOLDER/$reverted}"
          fi
          existing=$(gh pr list --head "$branch" --state open --json number --jq '.[0].number')
          if [ -n "$existing" ]; then
            gh pr edit "$existing" --body "$body"
          else
            gh pr create \
              --title "nix: update packages" \
              --body "$body" \
              --base main \
              --head "$branch"
          fi
